<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf8"/>
		<style type="text/css">
			html, body {
				margin: 0;
				padding: 0;
				background-color: black;
				color: white;
				font-family: monospace;
			}
			#log {
				padding: 10px;
				white-space: pre;
			}
			
		</style>
	</head>
	<body>
		<div id="log"></div>
		<script>
			const logEl = document.getElementById("log");
			function log(text) {
				if ( typeof(text) !== 'string' ) {
					text = JSON.stringify(text);
				}
				logEl.appendChild(document.createTextNode(text+"\r\n"));
			}
			const R = 0, D = 1, L = 2, U = 3;		
			
			const input_prod = [
				'.#.##.#...###.#.#.#.#.#....##....#...##...##..#.##..#..#.#.#.###..#....',
				'.....#.#..####.......#.###.....##.#..#.###.#.#..##.#.#.#.#..##.#.######',
				'#.####.##..####.#####.#.##.#..##.#.#.###.######.#.#.##..#####.#.##..##.',
				'#..#.####...#..##...#.#####.######.#...#....##..##..#......##.#####..##',
				'###..#.##..#########...#..####.#.#..##..#.#.#..###..##.###...##.#.#.#..',
				'..#..##.##.###..###.###...#.##..##.#####..#.###.....##...##......##.#..',
				'.###.#..#.#..#..#.##..#...##.#...#...##...##.####....#....#####..####.#',
				'..#####...#..###...#..#.#.#.#..#....#.##.#.#....#.#.#.#.....#.#...###..',
				'.#########.#...###.######..####.#..##..##.##......#..####....##.#....#.',
				'###.#.#....#..#.###..#....##...#..#.##.....#####...##.##...###......#..',
				'.##.##.###.##.###..#..#..##.##.####...#..#.....##..####.##.##...#.##..#',
				'..#..##.#.#...##.#.####.#.#####.########....##.###..#......##.#.####.##',
				'..######...#.#.#####.##...####...##...######.####..##.####...#####.##..',
				'########....##.#.#.#.....#.#.##.#.#...#.#.##..#..#....#...##.##..##..#.',
				'########..#..#.##.##.######...##.##.#..#.###.#..#.#...###...#.##.#####.',
				'#.##..#.##.##..###.##..########.#...###.#.#.###...####..#######.###...#',
				'.###.#.#######.#..#.#.#..#...##..#...##.######..###...#.#.#.#.###.#.###',
				'..###.#..###...#....#..###...##..###.#.#.#.#..##.....##...####..####..#',
				'..####..#..#...#####.#.#.......#.#####.###.##.#..#.#.......#.#.#.##.##.',
				'..##...####.#..###.##..#########.....#....#.#########.#.#...##.##.#....',
				'###..###.#...#...##.##..###..#####..#...#####.##..#.#.###.#.###..###..#',
				'...##...#...##..####.##.#.#..##.###.########.#..#..##.###.#.##.#.#....#',
				'...##.###.######..#.###.####.###..#..#.#....#.##.#.#.##..#..##.#.#.####',
				'######.####...#.....#.#..#..##.#...##.......##.#...######.......##..###',
				'.##..#...##..##.####.###.#.####....####...###.##..###.#.#####.##.......',
				'.##.#.###...#.###..###....#..###...##.#.###.#..###...##.....#..##.###..',
				'.##.#......#.#....#......#.##....###........##..####....#.#..#...#.....',
				'##..#..##..#...#.####..#.##..#####.#.##....##.#####.....###.#...#.###..',
				'#...#..#.#..####.#.#..##.###...##..##...#......#.......##....#..##..#.#',
				'.#..###..##.###......##..####..#.####.#........##.##.#..##.##..#.##..#.',
				'#######.#.#.###.##..##..##.####......#....#.#.#.##.#.#.##.#.###.##.###.',
				'#....#...#.#....###....#...#.#.....#...#.#####.#.......###.#.#..##..##.',
				'.#.#####..#....####.####..#..#....#....#####.##...#.#..##.#..#.#..#.#.#',
				'..##.#.###..##.##....##..####.#.#.#....#####.###..#####.#.#...#..##...#',
				'...#.##.#.#...#.#...#...##.##..#..###....#.#.#.##...#..####...#..##.#.#',
				'..##.#...#...####.#####..#.##.#.#.#..##.....#.##..##....#.....###..####',
				'#.######.###....######.##..#.#.###.##.###..#..####.#...#.#...#.#.##...#',
				'..#.##.#.#####.#....#.#.#..#.####.#..##.#..####.....#..#...##...####.#.',
				'.#..#.....####.#####.#.#.#.....##.##..##.#.#.#..#.....#....#...#.#..#..',
				'....##.##.#..##.##.###.#.......####.#.###..#..##..###.##....#.#.###....',
				'##.#.#.##.##..###..###.#.##.#..#....#.###..#####..##...###..#.##...##..',
				'##..##.##..##..#.##.##...#.###.#.##########...##.##########...###....#.',
				'.####.#.###.##.#####...###.#..##.####...##.##.#.###...##.######.#.#.###',
				'#..##.#..##........#..#.#######..........###..#..###.###.#.#.###.#..##.',
				'.#..###.#...###.####..#..#..#.#.###.##.#..##...#####.....###.......#..#',
				'#.##.####..###..#......#.##...#..#..#..#.....#.#....##.####..#.###.##.#',
				'.#.###..###.##.###.#.#.##.####.###..#..#..######.###.#...##..#.##..#..#',
				'#.#..#.........#.####..#....#.#....#.#####..##..#..#..#.....###.#..####',
				'.#.#....####.##.##.#...#......#.#.#.....#....#....#.##..#..##.#..##.###',
				'##...#..######........##.#...#####..#.#.#.####..#####.#.#...#.##..###..',
				'.##.####.#.##.##....#.#.#...#.#####..##......#.#.##.#.#.###.#......#..#',
				'############...##.##.#..#.#...#######.#....###....####..#.#######.#...#',
				'#.#.#..####..#.#.#..##......###.###...##.#..##..########.##.###..#..##.',
				'#.#.##.#.####..#.###.###.#.#.##.#....#######..###.#..##.#...#.###.###.#',
				'...#.#.....####....#...#.#.#....#..###..#.#.#.###..##.#..#...#..##..#.#',
				'.##.##...#...####....#....#.#.###..##.##..####.#..#.###.#####..##...#..',
				'...#..#..###..#...#######.#.###.##...#....####.#.#..##.##...#...#...###',
				'....#..#.#.#.##..#.##.#.###...###.....#.#..##.#.##..#.##.###..#.#.###.#',
				'####.#######.#.#.###...##.#..##..#.#...###..#...#.###.###....#...#...##',
				'.###.#.#.#...#....##.####.#....#.....#.#..##.##.##.#.##.#..#.#.......##',
				'#..###.##..###.##...###..#..##.#.#...##..#.#........#.###..######...#.#',
				'..######.###..###.#......#.#.###.####.#...#.#.##.#.......##..#.##....#.',
				'#.###.#.#.###.#.#.##.........##...#....#.###..#...#.#..#.##....#..##..#',
				'.##.#..#.#....#...#..###........#..#..##..##.#...#.###...########.##.##',
				'.##...#.....#.###.##....#.#..#..####.###...##...#..###...##..##.#####..',
				'#######..#.#.#.####.##..#######.#..##.#...###.....###.#..####.#.###.#.#',
				'.##..#...##.....##..###.##..##.###########.####..##.......#...#.###.#..',
				'....##....##.###.####...#..#....##.#.#.#...####.##..#...#.......##..#.#',
				'##..##.##.#..##.#...##.....#.##..#.#.##.##.#...#...#.##..#.#.#.#.#.##..',
				'##..##.##...##..##.###..##.##..########..##......#.#..#..###..#####..#.',
				'.#.##..#..##.######.#.#....##.###..#..#.#...#.#....####.#####.#.#..###.'
			];

			const input_test = [
				'....#..',
				'..###.#',
				'#...#.#',
				'.#...##',
				'#.###..',
				'##.#.##',
				'.#..#..'
			];
			
			const input = input_prod;
			
			
			const gridSize = 10000;
			const N = -gridSize;
			const S = gridSize;
			const W = -1;
			const E = 1;
			const NW = N + W;
			const NE = N + E;
			const SE = S + E;
			const SW = S + W;
			const considerations = [
				[N, NE, NW],
				[S, SE, SW],
				[W, NW, SW],
				[E, NE, SE]
			];
			let elves = [];
			let field = new Map();
			
			
			function packCoords(x, y) {
				return y * gridSize + x;;
			}
			
			function unpackCoords(c) {
				return {
					x: c % gridSize,
					y: Math.floor(c / gridSize)
				}
			}
			function getGridSize() {
				let minX = gridSize;
				let maxX = 0;
				let minY = gridSize;
				let maxY = 0;
				
				for ( let elf of elves ) {
					const {x, y} = unpackCoords(elf);
					
					if ( x < minX ) {
						minX = x;
					}
					if ( y < minY ) {
						minY = y;
					}
					if ( x > maxX ) {
						maxX = x;
					}
					if ( y > maxY ) {
						maxY = y;
					}
					
				}
				return { minX, maxX, minY, maxY, width: maxX-minX+1, height: maxY-minY+1 };
			}
			function drawGrid() {
				const size = getGridSize();
				for ( let y = size.minY; y <= size.maxY; y++ ) {
					const sb = [];
					for ( let x = size.minX; x <= size.maxX; x++ ) {
						sb.push(field.has(packCoords(x,y)) ? '#' : '.');
					}
					log(sb.join(''));
				}
			}
			

			const startX = gridSize / 2 - Math.floor(input[0].length / 2);
			const startY = gridSize / 2 - Math.floor(input.length / 2);
			
			let dirCycle = 0;
			
			for ( let y = 0; y < input.length; y++ ) {
				for (let x = 0; x < input[y].length; x++ ) {
					if ( input[y][x] == '#' ) {
						const coords = packCoords(x+startX, y+startY);
						field.set(coords, elves.length);
						elves.push(coords);
					}
				}
			}
			
			
			let newElves = new Array(elves.length);
			let newField = new Map()
			let elvesMoved = 1;
			let turn;
			//drawGrid();
			for ( turn = 0; elvesMoved > 0; turn++ ) {
				elvesMoved = 0;
				for ( let i = 0; i < elves.length; i++ ) {
					const elfPos = elves[i];
					
					const
						hasN = field.has(elfPos + N),
						hasS = field.has(elfPos + S),
						hasE = field.has(elfPos + E),
						hasW = field.has(elfPos + W),
						hasNE = field.has(elfPos + NE),
						hasNW = field.has(elfPos + NW),
						hasSE = field.has(elfPos + SE),
						hasSW = field.has(elfPos + SW);
					
					const canN = !hasN && !hasNE && !hasNW;
					const canS = !hasS && !hasSE && !hasSW;
					const canE = !hasE && !hasSE && !hasNE;
					const canW = !hasW && !hasSW && !hasNW;
						
					let move = 0;
					if ( !canN || !canS || !canE || !canW ) {
						switch ( dirCycle ) {
							case 0:
								move = canN ? N : canS ? S : canW ? W : canE ? E : 0;
								break;
							case 1:
								move = canS ? S : canW ? W : canE ? E : canN ? N : 0;
								break;
							case 2:
								move = canW ? W : canE ? E : canN ? N : canS ? S : 0;
								break;
							case 3:
								move = canE ? E : canN ? N : canS ? S : canW ? W : 0;
								break;
						}
					}
					
					if ( move == 0  )
					{
						newElves[i] = elfPos;
						newField.set(elfPos, i);
					} else {
						const newPos = elfPos + move;
						const targetElf = newField.get(newPos);
						
						if ( targetElf === undefined ) {
							newElves[i] = newPos;
							newField.set(newPos, i);
							elvesMoved++;
						} else {
							newElves[i] = elfPos;
							newField.set(elfPos, i);
							
							newElves[targetElf] = elves[targetElf];
							newField.delete(newPos);
							newField.set(elves[targetElf], targetElf);
							elvesMoved--;
						}
					}
				}
				
				const tmpElves = elves;
				elves = newElves;
				newElves = tmpElves;
				
				const tmpField = field;
				field = newField;
				newField = tmpField;
				newField.clear();
				
				dirCycle++;
				if ( dirCycle == 4 ) {
					dirCycle = 0;
				}
				//log(`After turn ${turn+1}`);
				//drawGrid();
				
				if ( turn == 9 ) {
					const { width, height } = getGridSize();					
					log(`width=${width}, height=${height}, elves=${elves.length}, answer1=${width*height-elves.length}`);					
				}
			}
			
			const { width, height } = getGridSize();					
			log(`width=${width}, height=${height}, elves=${elves.length}, answer2=${turn}`);
			drawGrid();
			
		</script>	
	</body>
</html>
